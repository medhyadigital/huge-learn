// This is your Prisma schema file for HUGE Learning Platform
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// 1. LEARNING CONTENT HIERARCHY
// ============================================================================

model LearningSchool {
  schoolId     String   @id @default(uuid()) @map("school_id") @db.VarChar(36)
  schoolName   String   @map("school_name") @db.VarChar(255)
  description  String?  @db.Text
  iconUrl      String?  @map("icon_url") @db.VarChar(500)
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  courses      Course[]
  
  @@index([isActive, displayOrder])
  @@map("learning_schools")
}

model Course {
  courseId         String          @id @default(uuid()) @map("course_id") @db.VarChar(36)
  schoolId         String          @map("school_id") @db.VarChar(36)
  courseName       String          @map("course_name") @db.VarChar(255)
  courseSlug       String          @unique @map("course_slug") @db.VarChar(255)
  shortDescription String?         @map("short_description") @db.VarChar(500)
  longDescription  String?         @map("long_description") @db.Text
  thumbnailUrl     String?         @map("thumbnail_url") @db.VarChar(500)
  bannerUrl        String?         @map("banner_url") @db.VarChar(500)
  durationDays     Int             @default(30) @map("duration_days")
  difficultyLevel  DifficultyLevel @default(beginner) @map("difficulty_level")
  totalLessons     Int             @default(0) @map("total_lessons")
  estimatedHours   Decimal         @default(0) @map("estimated_hours") @db.Decimal(5, 2)
  isFeatured       Boolean         @default(false) @map("is_featured")
  isActive         Boolean         @default(true) @map("is_active")
  displayOrder     Int             @default(0) @map("display_order")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  
  school       LearningSchool          @relation(fields: [schoolId], references: [schoolId], onDelete: Cascade)
  tracks       Track[]
  enrollments  UserCourseEnrollment[]
  certificates Certificate[]
  
  @@index([schoolId, isActive])
  @@index([isFeatured, isActive])
  @@index([courseSlug])
  @@map("courses")
}

model Track {
  trackId        String       @id @default(uuid()) @map("track_id") @db.VarChar(36)
  courseId       String       @map("course_id") @db.VarChar(36)
  trackName      String       @map("track_name") @db.VarChar(255)
  trackLevel     TrackLevel   @map("track_level")
  description    String?      @db.Text
  unlockCriteria Json?        @map("unlock_criteria")
  displayOrder   Int          @default(0) @map("display_order")
  isActive       Boolean      @default(true) @map("is_active")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  
  course  Course   @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  modules Module[]
  
  @@index([courseId, trackLevel])
  @@index([courseId, displayOrder])
  @@map("tracks")
}

model Module {
  moduleId     String   @id @default(uuid()) @map("module_id") @db.VarChar(36)
  trackId      String   @map("track_id") @db.VarChar(36)
  moduleName   String   @map("module_name") @db.VarChar(255)
  description  String?  @db.Text
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  track   Track    @relation(fields: [trackId], references: [trackId], onDelete: Cascade)
  lessons Lesson[]
  
  @@index([trackId, displayOrder])
  @@map("modules")
}

model Lesson {
  lessonId        String      @id @default(uuid()) @map("lesson_id") @db.VarChar(36)
  moduleId        String      @map("module_id") @db.VarChar(36)
  lessonName      String      @map("lesson_name") @db.VarChar(255)
  lessonType      LessonType  @default(text) @map("lesson_type")
  content         Json        @db.Json
  durationMinutes Int         @default(3) @map("duration_minutes")
  hasQuiz         Boolean     @default(false) @map("has_quiz")
  hasReflection   Boolean     @default(false) @map("has_reflection")
  displayOrder    Int         @default(0) @map("display_order")
  isActive        Boolean     @default(true) @map("is_active")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  
  module              Module                     @relation(fields: [moduleId], references: [moduleId], onDelete: Cascade)
  activities          Activity[]
  quizzes             Quiz[]
  userLessonProgress  UserLessonProgress[]
  
  @@index([moduleId, displayOrder])
  @@index([lessonType])
  @@map("lessons")
}

model Activity {
  activityId   String       @id @default(uuid()) @map("activity_id") @db.VarChar(36)
  lessonId     String       @map("lesson_id") @db.VarChar(36)
  activityType ActivityType @map("activity_type")
  content      Json         @db.Json
  isRequired   Boolean      @default(false) @map("is_required")
  displayOrder Int          @default(0) @map("display_order")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  
  lesson      Lesson                      @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)
  submissions UserActivitySubmission[]
  
  @@index([lessonId, activityType])
  @@map("activities")
}

model Quiz {
  quizId           String     @id @default(uuid()) @map("quiz_id") @db.VarChar(36)
  lessonId         String     @map("lesson_id") @db.VarChar(36)
  quizName         String?    @map("quiz_name") @db.VarChar(255)
  quizType         QuizType   @default(mcq) @map("quiz_type")
  questions        Json       @db.Json
  passingScore     Int        @default(70) @map("passing_score")
  maxAttempts      Int        @default(3) @map("max_attempts")
  timeLimitMinutes Int        @default(0) @map("time_limit_minutes")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  
  lesson   Lesson             @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)
  attempts UserQuizAttempt[]
  
  @@index([lessonId])
  @@map("quizzes")
}

// ============================================================================
// 2. USER LEARNING PROGRESS
// ============================================================================

model UserCourseEnrollment {
  enrollmentId        String             @id @default(uuid()) @map("enrollment_id") @db.VarChar(36)
  userId              String             @map("user_id") @db.VarChar(255)
  courseId            String             @map("course_id") @db.VarChar(36)
  enrolledAt          DateTime           @default(now()) @map("enrolled_at")
  currentTrackId      String?            @map("current_track_id") @db.VarChar(36)
  currentLessonId     String?            @map("current_lesson_id") @db.VarChar(36)
  completionPercentage Decimal           @default(0) @map("completion_percentage") @db.Decimal(5, 2)
  status              EnrollmentStatus   @default(not_started)
  completedAt         DateTime?          @map("completed_at")
  lastAccessedAt      DateTime           @default(now()) @map("last_accessed_at")
  
  course              Course                     @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  lessonProgress      UserLessonProgress[]
  quizAttempts        UserQuizAttempt[]
  activitySubmissions UserActivitySubmission[]
  
  @@unique([userId, courseId])
  @@index([userId, status])
  @@index([userId, lastAccessedAt(sort: Desc)])
  @@index([courseId, status])
  @@map("user_course_enrollments")
}

model UserLessonProgress {
  progressId          String           @id @default(uuid()) @map("progress_id") @db.VarChar(36)
  userId              String           @map("user_id") @db.VarChar(255)
  lessonId            String           @map("lesson_id") @db.VarChar(36)
  enrollmentId        String           @map("enrollment_id") @db.VarChar(36)
  status              ProgressStatus   @default(not_started)
  progressPercentage  Decimal          @default(0) @map("progress_percentage") @db.Decimal(5, 2)
  timeSpentSeconds    Int              @default(0) @map("time_spent_seconds")
  completionData      Json?            @map("completion_data") @db.Json
  startedAt           DateTime         @default(now()) @map("started_at")
  completedAt         DateTime?        @map("completed_at")
  lastAccessedAt      DateTime         @default(now()) @updatedAt @map("last_accessed_at")
  
  lesson     Lesson                @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)
  enrollment UserCourseEnrollment  @relation(fields: [enrollmentId], references: [enrollmentId], onDelete: Cascade)
  
  @@unique([userId, lessonId])
  @@index([userId, status])
  @@index([enrollmentId, status])
  @@index([userId, lastAccessedAt(sort: Desc)])
  @@map("user_lesson_progress")
}

model UserQuizAttempt {
  attemptId        String               @id @default(uuid()) @map("attempt_id") @db.VarChar(36)
  userId           String               @map("user_id") @db.VarChar(255)
  quizId           String               @map("quiz_id") @db.VarChar(36)
  enrollmentId     String               @map("enrollment_id") @db.VarChar(36)
  attemptNumber    Int                  @default(1) @map("attempt_number")
  answers          Json                 @db.Json
  score            Decimal              @default(0) @map("score") @db.Decimal(5, 2)
  passed           Boolean              @default(false)
  timeTakenSeconds Int                  @default(0) @map("time_taken_seconds")
  attemptedAt      DateTime             @default(now()) @map("attempted_at")
  
  quiz       Quiz                 @relation(fields: [quizId], references: [quizId], onDelete: Cascade)
  enrollment UserCourseEnrollment @relation(fields: [enrollmentId], references: [enrollmentId], onDelete: Cascade)
  
  @@index([userId, quizId])
  @@index([userId, enrollmentId])
  @@index([quizId, attemptedAt(sort: Desc)])
  @@map("user_quiz_attempts")
}

model UserActivitySubmission {
  submissionId String                @id @default(uuid()) @map("submission_id") @db.VarChar(36)
  userId       String                @map("user_id") @db.VarChar(255)
  activityId   String                @map("activity_id") @db.VarChar(36)
  enrollmentId String                @map("enrollment_id") @db.VarChar(36)
  submissionType SubmissionType      @default(text) @map("submission_type")
  content      Json                  @db.Json
  status       SubmissionStatus      @default(submitted)
  reviewerNotes String?              @map("reviewer_notes") @db.Text
  submittedAt  DateTime              @default(now()) @map("submitted_at")
  reviewedAt   DateTime?             @map("reviewed_at")
  
  activity   Activity             @relation(fields: [activityId], references: [activityId], onDelete: Cascade)
  enrollment UserCourseEnrollment @relation(fields: [enrollmentId], references: [enrollmentId], onDelete: Cascade)
  
  @@index([userId, activityId])
  @@index([status, submittedAt(sort: Desc)])
  @@map("user_activity_submissions")
}

// ============================================================================
// 3. GAMIFICATION SYSTEM
// ============================================================================

model Badge {
  badgeId       String        @id @default(uuid()) @map("badge_id") @db.VarChar(36)
  badgeName     String        @map("badge_name") @db.VarChar(255)
  badgeSlug     String        @unique @map("badge_slug") @db.VarChar(255)
  description   String?       @db.Text
  badgeIconUrl  String?       @map("badge_icon_url") @db.VarChar(500)
  badgeCategory BadgeCategory @default(learning) @map("badge_category")
  criteria      Json          @db.Json
  xpReward      Int           @default(0) @map("xp_reward")
  karmaReward   Int           @default(0) @map("karma_reward")
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  
  userBadges UserBadge[]
  
  @@index([badgeCategory, isActive])
  @@index([badgeSlug])
  @@map("badges")
}

model UserBadge {
  userBadgeId String   @id @default(uuid()) @map("user_badge_id") @db.VarChar(36)
  userId      String   @map("user_id") @db.VarChar(255)
  badgeId     String   @map("badge_id") @db.VarChar(36)
  earnedAt    DateTime @default(now()) @map("earned_at")
  context     Json?    @db.Json
  
  badge Badge @relation(fields: [badgeId], references: [badgeId], onDelete: Cascade)
  
  @@unique([userId, badgeId])
  @@index([userId, earnedAt(sort: Desc)])
  @@index([badgeId, earnedAt(sort: Desc)])
  @@map("user_badges")
}

model UserLearningMetrics {
  userId                 String   @id @map("user_id") @db.VarChar(255)
  totalXp                Int      @default(0) @map("total_xp")
  totalKarma             Int      @default(0) @map("total_karma")
  wisdomLevel            Int      @default(1) @map("wisdom_level")
  currentStreak          Int      @default(0) @map("current_streak")
  longestStreak          Int      @default(0) @map("longest_streak")
  totalLessonsCompleted  Int      @default(0) @map("total_lessons_completed")
  totalCoursesCompleted  Int      @default(0) @map("total_courses_completed")
  totalTimeSpentMinutes  Int      @default(0) @map("total_time_spent_minutes")
  lastActivityAt         DateTime @default(now()) @map("last_activity_at")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
  
  @@index([totalXp(sort: Desc)])
  @@index([totalKarma(sort: Desc)])
  @@index([wisdomLevel(sort: Desc)])
  @@index([lastActivityAt(sort: Desc)])
  @@map("user_learning_metrics")
}

model UserStreak {
  streakId          String   @id @default(uuid()) @map("streak_id") @db.VarChar(36)
  userId            String   @map("user_id") @db.VarChar(255)
  streakDate        DateTime @map("streak_date") @db.Date
  lessonsCompleted  Int      @default(0) @map("lessons_completed")
  timeSpentMinutes  Int      @default(0) @map("time_spent_minutes")
  xpEarned          Int      @default(0) @map("xp_earned")
  
  @@unique([userId, streakDate])
  @@index([userId, streakDate(sort: Desc)])
  @@map("user_streaks")
}

model UserXpTransaction {
  transactionId   String            @id @default(uuid()) @map("transaction_id") @db.VarChar(36)
  userId          String            @map("user_id") @db.VarChar(255)
  transactionType TransactionType   @default(xp) @map("transaction_type")
  amount          Int
  source          TransactionSource @map("source")
  sourceId        String?           @map("source_id") @db.VarChar(36)
  description     String?           @db.VarChar(500)
  createdAt       DateTime          @default(now()) @map("created_at")
  
  @@index([userId, transactionType, createdAt(sort: Desc)])
  @@index([source, sourceId])
  @@map("user_xp_transactions")
}

// ============================================================================
// 4. CERTIFICATES & CREDENTIALS
// ============================================================================

model Certificate {
  certificateId     String          @id @default(uuid()) @map("certificate_id") @db.VarChar(36)
  userId            String          @map("user_id") @db.VarChar(255)
  courseId          String          @map("course_id") @db.VarChar(36)
  certificateType   CertificateType @default(completion) @map("certificate_type")
  certificateNumber String          @unique @map("certificate_number") @db.VarChar(50)
  issueDate         DateTime        @map("issue_date") @db.Date
  expiryDate        DateTime?       @map("expiry_date") @db.Date
  certificateUrl    String?         @map("certificate_url") @db.VarChar(500)
  verificationCode  String          @unique @map("verification_code") @db.VarChar(100)
  metadata          Json?           @db.Json
  issuedAt          DateTime        @default(now()) @map("issued_at")
  
  course Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  
  @@index([userId, issueDate(sort: Desc)])
  @@index([courseId, issueDate(sort: Desc)])
  @@index([verificationCode])
  @@map("certificates")
}

// ============================================================================
// 5. AI MENTOR & RECOMMENDATIONS
// ============================================================================

model AiRecommendation {
  recommendationId   String             @id @default(uuid()) @map("recommendation_id") @db.VarChar(36)
  userId             String             @map("user_id") @db.VarChar(255)
  recommendationType RecommendationType @map("recommendation_type")
  targetId           String?            @map("target_id") @db.VarChar(36)
  priority           Int                @default(50)
  reason             String?            @db.Text
  context            Json?              @db.Json
  isShown            Boolean            @default(false) @map("is_shown")
  isActedUpon        Boolean            @default(false) @map("is_acted_upon")
  createdAt          DateTime           @default(now()) @map("created_at")
  expiresAt          DateTime?          @map("expires_at")
  
  @@index([userId, isShown, priority(sort: Desc)])
  @@index([userId, recommendationType, createdAt(sort: Desc)])
  @@map("ai_recommendations")
}

// ============================================================================
// ENUMS
// ============================================================================

enum DifficultyLevel {
  beginner
  intermediate
  advanced
}

enum TrackLevel {
  beginner
  intermediate
  advanced
}

enum LessonType {
  text
  video
  audio
  carousel
  mixed
}

enum ActivityType {
  reflection
  practice
  discussion
  seva_task
}

enum QuizType {
  mcq
  scenario
  matching
  true_false
}

enum EnrollmentStatus {
  not_started
  in_progress
  completed
  abandoned
}

enum ProgressStatus {
  not_started
  in_progress
  completed
}

enum SubmissionType {
  text
  audio
  video
  image
  link
}

enum SubmissionStatus {
  submitted
  reviewed
  approved
  rejected
}

enum BadgeCategory {
  learning
  karma
  streak
  social
  seva
  achievement
}

enum TransactionType {
  xp
  karma
}

enum TransactionSource {
  lesson
  quiz
  activity
  badge
  streak
  seva
  manual
}

enum CertificateType {
  completion
  mastery
  teaching
}

enum RecommendationType {
  next_course
  weak_topic
  group
  seva
  badge
}
